name: Deploy API to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: kascad-production
      REGION: europe-west1
      IMAGE_NAME: kascad-api
      SERVICE_NAME: kascad-api

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Set up .npmrc for GitHub Packages
        run: |
          echo "@kascad-app:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_TOKEN_GCP }}" >> .npmrc

      - name: Set up GCP credentials
        uses: google-github-actions/auth@v2
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS_PRODUCTION }}"

      - name: Configure Docker to use Artifact Registry
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/kascad/$IMAGE_NAME:$GITHUB_SHA .

      - name: Push to Google Artifact Registry
        run: |
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/kascad/$IMAGE_NAME:$GITHUB_SHA

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/kascad/${{ env.IMAGE_NAME }}:${{ github.sha }}
          region: ${{ env.REGION }}
          allow-unauthenticated: true
          timeout: 600s
